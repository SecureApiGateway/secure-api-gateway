name: Pull Request Build and Deploy

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/README.md'

env:
  SET_MAVEN_CONFIG: true
  PR_NUMBER: pr-${{ github.event.number }}
  SERVICE_NAME: ig
  CF_TRIGGER_NAME: github-actions-trigger-core
  CF_PIPELINE_NAME: SAPIG-devenv/dev-core-service-build
  CF_PIPELINE_BRANCH: main

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - name: Checkout CI Code 
        uses: actions/checkout@v4
        with: 
          repository: SecureApiGateway/secure-api-gateway-ci
          ref: 1389-standard-steps-for-workflows # To be removed after testing
      # Auth GCP, SDK & Artifact Registry
      - name: Call Authentication
        uses: ./.github/actions/authentication
        with: 
          garKey: ${{ secrets.DEV_GAR_KEY }}
          garLocation: ${{ vars.GAR_LOCATION }}      
      - name: Call build-image
        uses: ./.github/actions/build-image
        with:
          setMavenConfig: ${{ env.SET_MAVEN_CONFIG }}
          repositoryName: ${{ github.repository }}
          dockerBuildCommands: "make clean && make docker tag=$PR_NUMBER env=dev && make docker tag=$PR_NUMBER-prod"
          FR_ARTIFACTORY_USER: ${{ secrets.FR_ARTIFACTORY_USER }}
          FR_ARTIFACTORY_USER_ENCRYPTED_PASSWORD: ${{ secrets.FR_ARTIFACTORY_USER_ENCRYPTED_PASSWORD }}

  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: build
    steps:
      - name: Checkout CI Code 
        uses: actions/checkout@v4
        with: 
          repository: SecureApiGateway/secure-api-gateway-ci
          ref: 1389-standard-steps-for-workflows # To be removed after testing
      - name: Call deploy-to-env
        uses: ./.github/actions/deploy-to-env
        with: 
          prNumber: ${{ env.PR_NUMBER }}
          serviceName: ${{ env.SERVICE_NAME }}
          cfAPIKey: ${{ secrets.CF_API_KEY }}
          cfTriggerName: ${{ env.CF_TRIGGER_NAME }}
          cfPipelineName: ${{ env.CF_PIPELINE_NAME }}
          cfPipelineBranch: ${{ env.CF_PIPELINE_BRANCH }}